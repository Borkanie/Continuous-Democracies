name: Start ELK stack locally

on:
  workflow_dispatch:
   branches: [ "main", "add_elk_for_loging"]

jobs:
  start-elk:
    name: Start ELK on self-hosted runner
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start ELK (docker-compose)
        run: |
          set -e
          cd ops/elk
          docker-compose up -d

      - name: Wait for Elasticsearch
        run: |
          set -e
          for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15; do
            if curl -s http://localhost:9200/_cluster/health | grep -q '"status"'; then
              echo "Elasticsearch is up"
              break
            fi
            echo "Waiting for Elasticsearch..."
            sleep 2
          done

      - name: Upload ILM policy
        run: |
          set -e
          POLICY_FILE=ops/elk/ilm/filebeat-ilm-policy.json
          if [ -f "$POLICY_FILE" ]; then
            curl -s -X PUT "http://localhost:9200/_ilm/policy/filebeat-ilm-policy" -H 'Content-Type: application/json' --data-binary @$POLICY_FILE
            echo "ILM policy uploaded"
          else
            echo "ILM policy file not found: $POLICY_FILE"
            exit 1
          fi
